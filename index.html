<!DOCTYPE html>
<html lang="en" style="background: #2b2b2b;">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:; style-src 'self' 'unsafe-inline'; connect-src 'self'; worker-src 'self' blob:;">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Mumps Studio</title>

    <script src="./monaco-loader-init.js"></script>
    <script src="./src/app/perf-mode-early.js"></script>
    <script src="./src/app/applySettingsEarly.js"></script>
    <link rel="stylesheet" href="./styles/fonts.css?v=20251219-phase3b">
    <link rel="stylesheet" href="./styles/base.css?v=20251209-performance">
    <link rel="stylesheet" href="./styles/context-menu.css?v=20251209-performance">
    <link rel="stylesheet" href="./styles/layout.css?v=20251209-performance">
    <link rel="stylesheet" href="./styles/project-tree.css?v=20251209-performance">
    <link rel="stylesheet" href="./styles/tabs.css?v=20251209-performance">
    <link rel="stylesheet" href="./styles/toolbar.css?v=20251209-performance">
    <link rel="stylesheet" href="./styles/panels-terminal.css?v=20251209-performance">
    <link rel="stylesheet" href="./styles/debug-problems.css?v=20251209-performance">
    <link rel="stylesheet" href="./styles/search.css?v=20251209-performance">
    <link rel="stylesheet" href="./styles/connections.css?v=20251209-performance">
    <link rel="stylesheet" href="./styles/git.css?v=20251209-performance">
    <link rel="stylesheet" href="./styles/extensions.css?v=20251209-performance">
    <link rel="stylesheet" href="./styles/dialogs.css?v=20251219">
    <link rel="stylesheet" href="./styles/splash.css?v=20251213">

    <link rel="stylesheet" href="./node_modules/xterm/css/xterm.css">
</head>

<body>
    <div id="splashScreen" class="splash-screen">
        <div class="splash-content">
            <div class="splash-logo">
                <div class="m-logo">M</div>
            </div>
            <h1 class="splash-title">Mumps Studio</h1>
            <p class="splash-subtitle">Developed by Ahmad Alkhalaileh</p>
            <p class="splash-version">Version 1.1</p>
            <div class="splash-loader">
                <div class="loader-bar"></div>
            </div>
        </div>
    </div>

    <div class="app-shell">
        <header class="menu-bar">
            <div class="menu-left">
                <div class="brand">
                    <div class="brand-icon m-icon">M</div>
                    <div class="brand-meta">
                        <div class="brand-name">Mumps Studio</div>
                        <div class="brand-sub">Ahmad Alkhalaileh</div>
                    </div>
                </div>
                <nav class="menu-cluster" id="mainMenu"></nav>
            </div>
            <div class="menu-right"></div>
        </header>
        <div class="header-toolbar">
            <div class="toolbar-section toolbar-left">
                <div class="toolbar-group">
                    <button class="btn ghost icon-btn toolbar-btn" id="saveRoutineBtn" title="Save (Ctrl+S)">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path
                                d="M13.5 1h-11C1.7 1 1 1.7 1 2.5v11c0 .8.7 1.5 1.5 1.5h11c.8 0 1.5-.7 1.5-1.5v-11c0-.8-.7-1.5-1.5-1.5zM11 2v4H5V2h6zm2 11.5c0 .3-.2.5-.5.5h-9c-.3 0-.5-.2-.5-.5v-9c0-.3.2-.5.5-.5H4v5h8V4h.5c.3 0 .5.2.5.5v9z" />
                            <circle cx="8" cy="10" r="1.5" />
                        </svg>
                        <span class="btn-label">Save</span>
                    </button>
                </div>
                <div class="toolbar-group run-debug-widget">
                    <button class="btn ghost icon-btn toolbar-btn" id="lintBtn" title="Lint Code">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path
                                d="M8 1l-1.5 1.5L8 4 9.5 2.5 8 1zM3.5 3.5L2 5l1.5 1.5L5 5 3.5 3.5zm9 0L11 5l1.5 1.5L14 5l-1.5-1.5zM8 5c-1.7 0-3 1.3-3 3v5h6V8c0-1.7-1.3-3-3-3zm0 2c.6 0 1 .4 1 1v3H7V8c0-.6.4-1 1-1z" />
                        </svg>
                    </button>
                    <button class="btn primary icon-btn toolbar-btn run-btn" id="runBtn" title="Run (Ctrl+Enter)">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M4 2v12l10-6L4 2z" />
                        </svg>
                        <span class="btn-label">Run</span>
                    </button>
                    <button class="btn ghost icon-btn toolbar-btn" id="debugStartBtn" title="Debug (Shift+F9)">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path
                                d="M8 2C6.3 2 5 3.3 5 5v1H3v2h2v1c0 .7.2 1.3.6 1.9L4 12.5l1.4 1.4L7 12.3c.6.4 1.3.7 2 .7s1.4-.2 2-.7l1.6 1.6 1.4-1.4-1.6-1.6c.4-.5.6-1.2.6-1.9V8h2V6h-2V5c0-1.7-1.3-3-3-3zm0 2c.6 0 1 .4 1 1v5c0 .6-.4 1-1 1s-1-.4-1-1V5c0-.6.4-1 1-1z" />
                        </svg>
                        <span class="btn-label">Debug</span>
                    </button>
                    <div class="run-config-control">
                        <button class="btn ghost icon-btn toolbar-btn dropdown-btn" id="runConfigBtn"
                            title="Run/Debug configurations" aria-label="Run/Debug configurations">
                            <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M4 6l4 4 4-4H4z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="toolbar-section toolbar-right">
                <div class="vcs-widget" id="vcsWidget">
                    <button class="btn ghost icon-btn toolbar-btn vcs-toggle" id="vcsWidgetBtn" title="Git"
                        aria-label="Git">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <circle cx="4" cy="4" r="2" />
                            <circle cx="12" cy="12" r="2" />
                            <path d="M5.5 5.5l5 5" stroke="currentColor" stroke-width="1.8" fill="none" />
                        </svg>
                        <svg class="chevron-icon" width="12" height="12" viewBox="0 0 16 16" fill="none"
                            stroke="currentColor" stroke-width="1.4">
                            <path d="M4 6l4 4 4-4" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="ide-body">
            <div class="tool-window-bar tool-window-bar-left">
                <button class="tool-window-stripe-btn active" data-panel="projectPanel" data-position="left"
                    title="Project (Alt+1)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M2 2h5l2 2h5v10H2V2zm1 1v10h10V5H8.5L6.5 3H3z" />
                    </svg>
                    <span class="stripe-text">Project</span>
                </button>
                <button class="tool-window-stripe-btn" data-panel="structurePanel" data-position="left"
                    title="Structure (Alt+7)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M2 3h12v2H2zM4 7h10v2H4zM4 11h10v2H4z" />
                    </svg>
                    <span class="stripe-text">Structure</span>
                </button>
                <div class="stripe-spacer"></div>
            </div>

            <aside class="tool-window-content tool-window-left" id="leftToolWindow">
                <div class="tool-window-panel" id="projectPanel">
                    <div class="tool-window-header">
                        <span class="tool-window-title">Project</span>
                        <div class="tool-window-actions">
                            <button class="tool-window-action-btn" id="collapseAllBtn" title="Collapse All">
                                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M4 6l4 4 4-4H4z" />
                                </svg>
                            </button>
                            <button class="tool-window-action-btn" id="hideProjectBtn" title="Hide">
                                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.5" fill="none" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <input class="filter-input" id="routineFilterInput" placeholder="Filter...">
                    <div class="project-tree" id="projectTree"></div>
                </div>
                <div class="tool-window-panel hidden" id="structurePanel">
                    <div class="tool-window-header">
                        <span class="tool-window-title">Structure</span>
                        <div class="tool-window-actions">
                            <button class="tool-window-action-btn hide-panel-btn" title="Hide">
                                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.5" fill="none" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="tool-window-body">
                        <div class="placeholder-content">TODO: Structure tool window content</div>
                    </div>
                </div>
            </aside>

            <div class="ide-center">
                <main class="editor-area">
                    <div class="tabbar">
                        <div id="tabBar" class="tab-container"></div>
                    </div>
                    <div class="action-bar">
                        <div class="crumbs" id="breadcrumbs">
                            <span class="breadcrumb-item">Project</span>
                        </div>
                        <div class="actions"></div>
                    </div>
                    <div class="editor-frame">
                        <div id="editor"></div>
                    </div>
                </main>
            </div>
        </div>

        <div class="bottom-bar-wrapper" id="bottomBarWrapper">
            <div class="tool-window-bar tool-window-bar-bottom">
                <button class="tool-window-stripe-btn horizontal active" data-panel="terminalPanel"
                    data-position="bottom" title="Terminal (Alt+F12)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M2 3v10h12V3H2zm10 8H4V5h8v6z" />
                        <path d="M5 7l2 1.5L5 10" stroke="currentColor" fill="none" stroke-width="1.2" />
                        <path d="M8 9h2" stroke="currentColor" stroke-width="1.2" />
                    </svg>
                    <span class="stripe-text">Terminal</span>
                </button>
                <button class="tool-window-stripe-btn horizontal" data-panel="debugPanel" data-position="bottom"
                    title="Debug (Alt+5)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <circle cx="8" cy="8" r="3" fill="none" stroke="currentColor" stroke-width="1.5" />
                        <path d="M8 2v2M8 12v2M2 8h2M12 8h2" stroke="currentColor" stroke-width="1.2" />
                    </svg>
                    <span class="stripe-text">Debug</span>
                </button>
                <button class="tool-window-stripe-btn horizontal" data-panel="problemsPanel" data-position="bottom"
                    title="Problems (Alt+6)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 2l6 12H2L8 2z" />
                        <path d="M8 6v4" stroke="#2b2b2b" stroke-width="1.2" />
                        <circle cx="8" cy="12" r="0.8" fill="#2b2b2b" />
                    </svg>
                    <span class="stripe-text">Problems</span>
                </button>
                <div class="stripe-spacer"></div>
                <button class="tool-window-stripe-btn horizontal" data-panel="extensionsPanel" data-position="bottom"
                    title="Extensions (Alt+E)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <rect x="2" y="2" width="12" height="12" rx="3" fill="none" stroke="currentColor"
                            stroke-width="1.2" />
                        <path d="M5 5h6v2H5zM5 9h6v2H5z" fill="currentColor" />
                    </svg>
                    <span class="stripe-text">Extensions</span>
                </button>
                <button class="tool-window-stripe-btn horizontal" data-panel="servicesPanel" data-position="bottom"
                    title="Services (Alt+8)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <rect x="2" y="5" width="12" height="7" rx="1" fill="none" stroke="currentColor"
                            stroke-width="1.5" />
                        <path d="M6 3h4v2H6z" />
                    </svg>
                    <span class="stripe-text">Services</span>
                </button>
            </div>
            <div class="tool-window-content tool-window-bottom" id="bottomToolWindow">
                <div class="bottom-panels-container">
                    <section class="panel terminal" id="terminalPanel"></section>
                    <section class="panel debug-panel hidden" id="debugPanel"></section>
                    <section class="panel debug-panel hidden" id="problemsPanel"></section>
                    <section class="panel debug-panel hidden" id="gitToolPanel"></section>
                    <section class="panel debug-panel hidden" id="extensionsPanel"></section>
                    <section class="panel debug-panel hidden" id="servicesPanel"></section>
                </div>
            </div>
        </div>

        <footer class="statusbar">
            <div class="status-left">
                <span class="status-item" id="gitBranch" title="Git Branch">
                    <span class="icon">⎇</span> —
                </span>
                <span class="status-item" id="problemsSummary" title="Problems">
                    <span class="icon">⚠</span> 0
                </span>
            </div>
            <div class="status-right">
                <span class="status-item" id="lineColInfo" title="Line:Column">Ln 1, Col 1</span>
                <span class="status-item" id="currentRoutineLabel" title="Current File">main.m</span>
                <span class="status-item" id="fileLanguage" title="Language">MUMPS</span>
                <span class="status-item" id="fileEncoding" title="Encoding">UTF-8</span>
                <span class="status-item" id="lineEndings" title="Line Endings">LF</span>
                <span class="status-item" id="toggleConnections" title="Open Connections panel">Connections</span>
                <span class="status-item status-pill"><span class="pill subtle" id="connStatus">Ready</span></span>
                <span class="status-item" id="envInfo">Loading...</span>
            </div>
        </footer>
    </div>

    <!-- Connections Panel Overlay -->
    <div id="connectionsOverlay" class="connections-overlay hidden"></div>
    <div id="connectionsPanel" class="connections-panel hidden"></div>

    <!-- Search Dialogs (Phase 3) -->
    <div id="findOverlay" class="ui-dialog-overlay hidden"></div>
    <div id="findDialog" class="search-dialog hidden"></div>

    <div id="searchEverywhereOverlay" class="ui-dialog-overlay hidden"></div>
    <div id="searchEverywhereDialog" class="search-everywhere hidden"></div>

    <div class="toast-container" id="toastContainer"></div>

    <div id="debugBar" class="debug-float hidden">
        <button data-cmd="continue" id="dbgContinueBtn" title="Resume Program (F9)">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="#6a9955">
                <path d="M4 3l9 5-9 5V3z" />
            </svg>
        </button>
        <button data-cmd="pause" id="dbgPauseBtn" title="Pause Program">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M4 3h3v10H4V3zm5 0h3v10H9V3z" />
            </svg>
        </button>
        <button data-cmd="step-over" id="dbgStepOverBtn" title="Step Over (F8)">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path
                    d="M8 4a3 3 0 0 0-3 3v2h2V7a1 1 0 0 1 1-1h1.59l-1.3 1.29 1.42 1.42L13.41 5 9.71 1.29 8.29 2.71 9.59 4H8zM3 13h10v-2H3v2z" />
            </svg>
        </button>
        <button data-cmd="step-into" id="dbgStepIntoBtn" title="Step Into (F7)">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path
                    d="M8 2a1 1 0 0 0-1 1v4H5.5l2.5 2.5 2.5-2.5H9V3a1 1 0 0 0-1-1zM4 14h8a1 1 0 0 0 1-1v-1a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1z" />
            </svg>
        </button>
        <button data-cmd="step-out" id="dbgStepOutBtn" title="Step Out (Shift+F8)">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path
                    d="M8 10a1 1 0 0 0 1-1V5h1.5L8 2.5 5.5 5H7v4a1 1 0 0 0 1 1zM4 14h8a1 1 0 0 0 1-1v-1a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1z" />
            </svg>
        </button>
        <button data-cmd="restart" id="dbgRestartBtn" title="Restart Debugger">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="#5fb4b4">
                <path d="M8 3a5 5 0 0 0-4.59 3H2l3 4 3-4H6.06a3.06 3.06 0 1 1 .5 5.23l1.37 1.37A5 5 0 1 0 8 3z" />
            </svg>
        </button>
        <button data-cmd="stop" id="dbgStopBtn" title="Stop Debugger (Ctrl+F2)">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="#f48771">
                <rect x="3" y="3" width="10" height="10" rx="1" />
            </svg>
        </button>
    </div>

    <script src="./libs/jquery.min.js"></script>
    <script src="./assets/mumps/mumps-validator.js"></script>
    <script src="./assets/mumps/mumps-linter.js"></script>
    <script src="./assets/mumps/mumps-lexer.js"></script>
    <script src="./utils/debug-log.js"></script>
    <script src="./utils/logger.js"></script>
    <script src="./src/services/settingsService.js"></script>
    <script src="./src/services/fontService.js"></script>
    <script src="./src/services/extensionsService.js"></script>
    <script src="./src/app/registries/dialogRegistry.js"></script>
    <script src="./src/ui/theme/tokens.js"></script>
    <script src="./src/ui/primitives/Button.js"></script>
    <script src="./src/ui/primitives/Input.js"></script>
    <script src="./src/ui/primitives/Select.js"></script>
    <script src="./src/ui/primitives/Checkbox.js"></script>
    <script src="./src/ui/primitives/Toggle.js"></script>
    <script src="./src/ui/primitives/List.js"></script>
    <script src="./src/ui/Dialog.js"></script>
    <script src="./src/ui/DialogLayout.js"></script>
    <script src="./src/ui/primitives/Dialog.prompt.js"></script>
    <script src="./src/features/settings/sections/appearance.js"></script>
    <script src="./src/features/settings/sections/fonts.shared.js"></script>
    <script src="./src/features/settings/sections/fonts.ui.js"></script>
    <script src="./src/features/settings/sections/fonts.editor.js"></script>
    <script src="./src/features/settings/sections/fonts.terminal.js"></script>
    <script src="./src/features/settings/sections/fonts.js"></script>
    <script src="./src/features/settings/sections/advanced.js"></script>
    <script src="./src/features/settings/settingsDialog.js"></script>
    <script src="./src/features/connections/connectionsDialog.js"></script>
    <script src="./src/features/about/aboutDialog.js"></script>
    <script src="./src/features/shortcuts/shortcutsDialog.js"></script>
    <script src="./src/features/projects/newProjectDialog.js"></script>
    <script src="./src/features/projects/openProjectDialog.js"></script>
    <script src="./src/features/search/findReplaceDialog.js"></script>
    <script src="./src/features/search/searchEverywhereDialog.js"></script>
    <script src="./src/features/extensions/extensionsToolWindow.js"></script>
    <script src="./src/extensions/bundled/git.js"></script>
    <script src="./src/extensions/bundled/mumps-tools.js"></script>
    <script src="./src/editor/mumps/mumps-local-tags.js"></script>
    <script src="./src/editor/tabs/renderer-tabs.js"></script>
    <script src="./src/editor/terminal/renderer-terminal.js"></script>
    <script src="./src/features/terminal/engine-loader.js"></script>
    <script src="./src/features/terminal/layout.js"></script>
    <script src="./src/features/terminal/plain-fallback.js"></script>
    <script src="./src/editor/search/renderer-search.js"></script>
    <script src="./src/editor/debug/renderer-debug.js"></script>
    <script src="./src/editor/problems/renderer-problems.js"></script>
    <script src="./src/editor/diagnostics/renderer-diagnostics.js"></script>
    <script src="./src/editor/extensions/renderer-extensions.js"></script>
    <script src="./src/editor/git/renderer-git-toolwindow.js"></script>
    <script src="./src/editor/git/renderer-git-settings.js"></script>
    <script src="./src/editor/connections/renderer-connections.js"></script>
    <script src="./src/editor/project/renderer-project-create.js"></script>
    <script src="./src/editor/project/renderer-project-context-menu.js"></script>
    <script src="./src/editor/project/renderer-project-tree.js"></script>
    <script src="./src/editor/routines/renderer-routines.js"></script>
    <script src="./src/editor/ui/renderer-editor-context-menu.js"></script>
    <script src="./src/editor/ui/renderer-settings-panel.js"></script>
    <script src="./src/editor/ui/renderer-ctrl-hover.js"></script>
    <script src="./src/editor/mumps/renderer-mumps-monaco.js"></script>
    <script src="./src/ui/virtual-list.js"></script>
    <script src="./src/features/git/perf-ui.js"></script>
    <script src="./src/app/monaco-layout-scheduler.js"></script>
    <script src="./src/app/feature-registry.js"></script>
    <script src="./src/app/lazy-panels.templates.js"></script>
    <script src="./src/app/lazy-panels.bootstrap.js"></script>
    <script src="./src/features/services/panel-bindings.js"></script>
    <script src="./src/app/perf-mode.js"></script>
    <script src="./src/app/registries/menuRegistry.js?v=fix1"></script>
    <script src="./src/ui/icons/iconRegistry.js"></script>
    <script src="./src/ui/menu/menuUtils.js"></script>
    <script src="./src/ui/menu/submenuIntent.js"></script>
    <script src="./src/ui/menu/menuController.js"></script>
    <script src="./src/ui/menu/menuBar.js"></script>
    <script src="./src/features/menus/menuActions.js"></script>
    <script src="./src/features/menus/phase3a-menus.js"></script>
    <script src="./src/app/wireDialogs.js"></script>
    <script src="./renderer.js"></script>

    <script>
        (function () {
            const splashScreen = document.getElementById('splashScreen');
            if (!splashScreen) return;

            let monacoReady = false;
            let minTimeElapsed = false;

            // Minimum display time (smoother UX)
            setTimeout(() => {
                minTimeElapsed = true;
                tryHideSplash();
            }, 1500);

            // Maximum wait time (fallback if modules fail to load)
            setTimeout(() => {
                console.warn('Splash timeout - forcing hide after 5s');
                hideSplash();
            }, 5000);

            // Wait for Monaco to be ready
            function waitForMonaco() {
                if (typeof monaco !== 'undefined' && monaco.editor) {
                    monacoReady = true;
                    tryHideSplash();
                } else {
                    setTimeout(waitForMonaco, 100);
                }
            }

            function tryHideSplash() {
                // Only hide when editor is ready AND minimum time passed
                if (monacoReady && minTimeElapsed) {
                    hideSplash();
                }
            }

            function hideSplash() {
                splashScreen.classList.add('fade-out');
                setTimeout(() => {
                    splashScreen.remove();
                }, 600);
            }

            // Start waiting for critical modules
            waitForMonaco();
        })();
    </script>
</body>

</html>